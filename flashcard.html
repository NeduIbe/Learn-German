<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>German Flashcard Master (A1-B1)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom Styles for Card Flip and Layout */
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .flashcard-container {
            perspective: 1000px;
            width: 350px;
            height: 220px;
            margin: 3rem auto;
            max-width: 100%;
        }
        .flashcard {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
        }
        .flashcard.flipped {
            transform: rotateY(180deg);
        }
        .flashcard-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 1.5rem;
            border-radius: 0.75rem;
            text-align: center;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .flashcard-back {
            transform: rotateY(180deg);
            background-color: #ecf0f1;
        }
        .flashcard-front {
            background-color: #ffffff;
        }
        .hidden { display: none; }
        .section-container { max-width: 800px; margin: 0 auto; padding: 1rem; }
    </style>
</head>
<body class="min-h-screen">
    
    <!-- GLOBAL NAVIGATION BAR ADDED HERE -->
    <nav class="bg-white shadow-lg sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-start h-14 space-x-6">
                <!-- Links to other pages -->
                <a href="./index.html" class="text-slate-700 hover:text-indigo-600 font-medium py-2 transition duration-150 rounded-md px-3 hover:bg-slate-100">Home</a>
                <a href="./practice.html" class="text-slate-700 hover:text-indigo-600 font-medium py-2 transition duration-150 rounded-md px-3 hover:bg-slate-100">Practice</a>
                <!-- NEW FLASH CARDS LINK ADDED -->
                <a href="./flashcard.html" class="text-slate-700 hover:text-indigo-600 font-medium py-2 transition duration-150 rounded-md px-3 hover:bg-slate-100">Flash Cards</a>
                <a href="./promptpractice.html" class="text-slate-700 hover:text-indigo-600 font-medium py-2 transition duration-150 rounded-md px-3 hover:bg-slate-100">Prompt</a>
            </div>
        </div>
    </nav>
    <!-- END GLOBAL NAVIGATION BAR -->

    <!-- APPLICATION HEADER (For Title and Internal SPA Navigation) -->
    <header class="bg-gray-800 text-white shadow-lg z-10">
        <div class="container mx-auto px-4 py-3 flex flex-col sm:flex-row justify-between items-center">
            <h1 class="text-2xl font-bold mb-2 sm:mb-0">German Flashcard Master (A1-B1)</h1>
            <nav id="app-nav">
                <button id="nav-learn" class="px-4 py-2 mx-1 rounded-lg bg-indigo-600 hover:bg-indigo-700 transition duration-150">Learn</button>
                <button id="nav-add" class="px-4 py-2 mx-1 rounded-lg bg-gray-600 hover:bg-gray-700 transition duration-150">Add Cards</button>
                <button id="nav-settings" class="px-4 py-2 mx-1 rounded-lg bg-gray-600 hover:bg-gray-700 transition duration-150">Settings</button>
                <button id="nav-about" class="px-4 py-2 mx-1 rounded-lg bg-gray-600 hover:bg-gray-700 transition duration-150">About</button>
            </nav>
        </div>
    </header>

    <main id="app-container" class="container mx-auto p-4 md:p-8">
        <!-- LEARN SECTION -->
        <section id="learn-section" class="section-container bg-white p-6 rounded-xl shadow-xl">
            <!-- Content rendered by JavaScript -->
        </section>

        <!-- ADD CARDS SECTION -->
        <section id="add-section" class="section-container bg-white p-6 rounded-xl shadow-xl hidden">
            <!-- Content rendered by JavaScript -->
        </section>

        <!-- SETTINGS SECTION -->
        <section id="settings-section" class="section-container bg-white p-6 rounded-xl shadow-xl hidden">
            <!-- Content rendered by JavaScript -->
        </section>

        <!-- ABOUT SECTION -->
        <section id="about-section" class="section-container bg-white p-6 rounded-xl shadow-xl hidden">
            <!-- Content rendered by JavaScript -->
        </section>
    </main>

    <footer class="text-center py-4 text-gray-600 border-t mt-8">
        <p>&copy; 2024 German Flashcard Master. Data saved locally in your browser.</p>
    </footer>

    <script>
        // --- Data Structure and Seed Data ---

        class Flashcard {
            constructor(id, german, translation, level = 'A1', category = 'General', hint = '', exampleSentence = '') {
                this.id = id;
                this.german = german;
                this.translation = translation;
                this.level = level; // A1, A2, B1, etc.
                this.category = category;
                this.hint = hint; // e.g., "(m)" for Masculine Noun
                this.exampleSentence = exampleSentence;
                this.lastReviewed = null; // Timestamp
                this.nextReview = null; // Timestamp for Spaced Repetition
                this.interval = 0; // Interval in days (SM-2)
                this.easeFactor = 2.5; // Ease factor (SM-2)
            }
        }

        const initialVocab = [
            // A1 VOCABULARY (~50 words)
            new Flashcard('a1_1', 'Hallo', 'Hello', 'A1', 'Greetings'),
            new Flashcard('a1_2', 'Danke', 'Thank you', 'A1', 'Greetings'),
            new Flashcard('a1_3', 'Bitte', 'Please / You\'re welcome', 'A1', 'Greetings'),
            new Flashcard('a1_4', 'Entschuldigung', 'Excuse me / Sorry', 'A1', 'Greetings'),
            new Flashcard('a1_5', 'Ja / Nein', 'Yes / No', 'A1', 'Basic'),
            new Flashcard('a1_6', 'Ich', 'I', 'A1', 'Pronouns'),
            new Flashcard('a1_7', 'Du', 'You (singular informal)', 'A1', 'Pronouns'),
            new Flashcard('a1_8', 'Er / Sie / Es', 'He / She / It', 'A1', 'Pronouns'),
            new Flashcard('a1_9', 'Wir', 'We', 'A1', 'Pronouns'),
            new Flashcard('a1_10', 'Sie (Plural)', 'They / You (formal)', 'A1', 'Pronouns'),
            new Flashcard('a1_11', 'Sein (v)', 'To be', 'A1', 'Verbs', 'Ist, Bin, Sind', 'Ich bin mÃ¼de.'),
            new Flashcard('a1_12', 'Haben (v)', 'To have', 'A1', 'Verbs', 'Habe, Hast, Hat', 'Er hat einen Hund.'),
            new Flashcard('a1_13', 'HeiÃŸen (v)', 'To be called', 'A1', 'Verbs', 'HeiÃŸe, HeiÃŸt', 'Wie heiÃŸen Sie?'),
            new Flashcard('a1_14', 'Kommen (v)', 'To come', 'A1', 'Verbs', 'Komme, Kommst', 'Ich komme aus Deutschland.'),
            new Flashcard('a1_15', 'Der Mann (m)', 'The man', 'A1', 'Nouns'),
            new Flashcard('a1_16', 'Die Frau (f)', 'The woman', 'A1', 'Nouns'),
            new Flashcard('a1_17', 'Das Kind (n)', 'The child', 'A1', 'Nouns'),
            new Flashcard('a1_18', 'Das Haus (n)', 'The house', 'A1', 'Nouns'),
            new Flashcard('a1_19', 'Der Tisch (m)', 'The table', 'A1', 'Nouns'),
            new Flashcard('a1_20', 'Das Buch (n)', 'The book', 'A1', 'Nouns'),
            new Flashcard('a1_21', 'Eins, Zwei, Drei', 'One, Two, Three', 'A1', 'Numbers'),
            new Flashcard('a1_22', 'GroÃŸ / Klein', 'Big / Small', 'A1', 'Adjectives'),
            new Flashcard('a1_23', 'Gut / Schlecht', 'Good / Bad', 'A1', 'Adjectives'),
            new Flashcard('a1_24', 'Das Wasser (n)', 'The water', 'A1', 'Nouns'),
            new Flashcard('a1_25', 'Der Kaffee (m)', 'The coffee', 'A1', 'Nouns'),
            new Flashcard('a1_26', 'Essen (v)', 'To eat', 'A1', 'Verbs'),
            new Flashcard('a1_27', 'Trinken (v)', 'To drink', 'A1', 'Verbs'),
            new Flashcard('a1_28', 'Schlafen (v)', 'To sleep', 'A1', 'Verbs'),
            new Flashcard('a1_29', 'Sprechen (v)', 'To speak', 'A1', 'Verbs'),
            new Flashcard('a1_30', 'Wie geht es Ihnen?', 'How are you? (formal)', 'A1', 'Phrases'),
            new Flashcard('a1_31', 'Die Uhr (f)', 'The clock / hour', 'A1', 'Nouns'),
            new Flashcard('a1_32', 'Gestern / Heute / Morgen', 'Yesterday / Today / Tomorrow', 'A1', 'Adverbs'),
            new Flashcard('a1_33', 'Dort / Hier', 'There / Here', 'A1', 'Adverbs'),
            new Flashcard('a1_34', 'Die Familie (f)', 'The family', 'A1', 'Nouns'),
            new Flashcard('a1_35', 'Lernen (v)', 'To learn', 'A1', 'Verbs'),
            new Flashcard('a1_36', 'Die Arbeit (f)', 'The work / job', 'A1', 'Nouns'),
            new Flashcard('a1_37', 'Die Wohnung (f)', 'The apartment', 'A1', 'Nouns'),
            new Flashcard('a1_38', 'Kaufen (v)', 'To buy', 'A1', 'Verbs'),
            new Flashcard('a1_39', 'Zahlen (v)', 'To pay', 'A1', 'Verbs'),
            new Flashcard('a1_40', 'Die Rechnung (f)', 'The bill', 'A1', 'Nouns'),
            // A2 VOCABULARY (~50 words)
            new Flashcard('a2_1', 'MÃ¼ssen (modal)', 'Must / To have to', 'A2', 'Modals', 'Ich muss gehen.'),
            new Flashcard('a2_2', 'DÃ¼rfen (modal)', 'May / To be allowed to', 'A2', 'Modals', 'Du darfst hier parken.'),
            new Flashcard('a2_3', 'Sollen (modal)', 'Should / Ought to', 'A2', 'Modals', 'Wir sollen pÃ¼nktlich sein.'),
            new Flashcard('a2_4', 'MÃ¶chten (modal)', 'Would like to', 'A2', 'Modals', 'Ich mÃ¶chte ein Bier.'),
            new Flashcard('a2_5', 'Wollen (modal)', 'To want to', 'A2', 'Modals'),
            new Flashcard('a2_6', 'Mit (prep + dat)', 'With', 'A2', 'Prepositions', 'Ich fahre mit dem Auto.'),
            new Flashcard('a2_7', 'Nach (prep + dat)', 'After / To (a city/country)', 'A2', 'Prepositions', 'Nach der Arbeit.'),
            new Flashcard('a2_8', 'Von (prep + dat)', 'From / Of', 'A2', 'Prepositions', 'Von Montag bis Freitag.'),
            new Flashcard('a2_9', 'Seit (prep + dat)', 'Since / For (time)', 'A2', 'Prepositions', 'Er wohnt seit 2020 hier.'),
            new Flashcard('a2_10', 'Durch (prep + acc)', 'Through', 'A2', 'Prepositions'),
            new Flashcard('a2_11', 'FÃ¼r (prep + acc)', 'For', 'A2', 'Prepositions'),
            new Flashcard('a2_12', 'Um (prep + acc)', 'Around / At (time)', 'A2', 'Prepositions'),
            new Flashcard('a2_13', 'Anrufen (sep. v)', 'To call (by phone)', 'A2', 'Verbs', 'Ich rufe dich an.'),
            new Flashcard('a2_14', 'Aufstehen (sep. v)', 'To get up', 'A2', 'Verbs', 'Ich stehe frÃ¼h auf.'),
            new Flashcard('a2_15', 'Einkaufen (sep. v)', 'To shop', 'A2', 'Verbs'),
            new Flashcard('a2_16', 'Zuerst / Dann / SpÃ¤ter', 'First / Then / Later', 'A2', 'Adverbs'),
            new Flashcard('a2_17', 'Der Zug (m)', 'The train', 'A2', 'Nouns'),
            new Flashcard('a2_18', 'Die Haltestelle (f)', 'The bus/tram stop', 'A2', 'Nouns'),
            new Flashcard('a2_19', 'Das Museum (n)', 'The museum', 'A2', 'Nouns'),
            new Flashcard('a2_20', 'Wichtig', 'Important', 'A2', 'Adjectives'),
            new Flashcard('a2_21', 'Besser / Am besten', 'Better / Best', 'A2', 'Adjectives', 'Comparative/Superlative'),
            new Flashcard('a2_22', 'Mehr / Am meisten', 'More / Most', 'A2', 'Adjectives', 'Comparative/Superlative'),
            new Flashcard('a2_23', 'Der Termin (m)', 'The appointment', 'A2', 'Nouns'),
            new Flashcard('a2_24', 'ErklÃ¤ren (v)', 'To explain', 'A2', 'Verbs'),
            new Flashcard('a2_25', 'Der FÃ¼hrerschein (m)', 'The driving license', 'A2', 'Nouns'),
            new Flashcard('a2_26', 'Die Meinung (f)', 'The opinion', 'A2', 'Nouns'),
            new Flashcard('a2_27', 'Hoffen (v)', 'To hope', 'A2', 'Verbs'),
            new Flashcard('a2_28', 'Besuchen (v)', 'To visit', 'A2', 'Verbs'),
            new Flashcard('a2_29', 'Lachen (v)', 'To laugh', 'A2', 'Verbs'),
            new Flashcard('a2_30', 'Weinen (v)', 'To cry', 'A2', 'Verbs'),
            new Flashcard('a2_31', 'Das Geschenk (n)', 'The gift', 'A2', 'Nouns'),
            new Flashcard('a2_32', 'Die Kleidung (f)', 'The clothing', 'A2', 'Nouns'),
            new Flashcard('a2_33', 'Brauchen (v)', 'To need', 'A2', 'Verbs'),
            new Flashcard('a2_34', 'Probieren (v)', 'To try (food/clothes)', 'A2', 'Verbs'),
            new Flashcard('a2_35', 'Der Unterschied (m)', 'The difference', 'A2', 'Nouns'),
            new Flashcard('a2_36', 'Gleich', 'Immediately / Equal', 'A2', 'Adverbs'),
            new Flashcard('a2_37', 'Die Vergangenheit (f)', 'The past', 'A2', 'Nouns'),
            new Flashcard('a2_38', 'Die Zukunft (f)', 'The future', 'A2', 'Nouns'),
            new Flashcard('a2_39', 'Sich Ã¤rgern Ã¼ber (v)', 'To be annoyed about', 'A2', 'Verbs', 'Reflexive'),
            new Flashcard('a2_40', 'Sich interessieren fÃ¼r (v)', 'To be interested in', 'A2', 'Verbs', 'Reflexive'),
            // B1 VOCABULARY (~50 words)
            new Flashcard('b1_1', 'Obwohl (conj)', 'Although', 'B1', 'Conjunctions', 'Nebensatz/Subordinate Clause'),
            new Flashcard('b1_2', 'Weil (conj)', 'Because', 'B1', 'Conjunctions', 'Nebensatz/Subordinate Clause'),
            new Flashcard('b1_3', 'Dass (conj)', 'That', 'B1', 'Conjunctions', 'Nebensatz/Subordinate Clause'),
            new Flashcard('b1_4', 'Damit (conj)', 'In order that / So that', 'B1', 'Conjunctions', 'Nebensatz/Subordinate Clause'),
            new Flashcard('b1_5', 'Trotzdem (adv)', 'Nevertheless / Still', 'B1', 'Adverbs'),
            new Flashcard('b1_6', 'Der Zustand (m)', 'The condition / state', 'B1', 'Nouns'),
            new Flashcard('b1_7', 'Die Gesellschaft (f)', 'The society', 'B1', 'Nouns'),
            new Flashcard('b1_8', 'Die Gelegenheit (f)', 'The opportunity', 'B1', 'Nouns'),
            new Flashcard('b1_9', 'Die Entwicklung (f)', 'The development', 'B1', 'Nouns'),
            new Flashcard('b1_10', 'VerfÃ¼gbar', 'Available', 'B1', 'Adjectives'),
            new Flashcard('b1_11', 'Notwendig', 'Necessary', 'B1', 'Adjectives'),
            new Flashcard('b1_12', 'Geeignet', 'Suitable / appropriate', 'B1', 'Adjectives'),
            new Flashcard('b1_13', 'Die Verantwortung (f)', 'The responsibility', 'B1', 'Nouns'),
            new Flashcard('b1_14', 'Behaupten (v)', 'To claim / assert', 'B1', 'Verbs'),
            new Flashcard('b1_15', 'Erkennen (v)', 'To recognize / identify', 'B1', 'Verbs'),
            new Flashcard('b1_16', 'Feststellen (v)', 'To ascertain / determine', 'B1', 'Verbs'),
            new Flashcard('b1_17', 'Ãœberlegen (v)', 'To consider / reflect', 'B1', 'Verbs'),
            new Flashcard('b1_18', 'WÃ¼rde (Subj. II)', 'Would', 'B1', 'Grammar', 'Konjunktiv II (Subjunctive II)'),
            new Flashcard('b1_19', 'HÃ¤tte (Subj. II)', 'Would have', 'B1', 'Grammar', 'Konjunktiv II (Subjunctive II)'),
            new Flashcard('b1_20', 'WÃ¤re (Subj. II)', 'Would be', 'B1', 'Grammar', 'Konjunktiv II (Subjunctive II)'),
            new Flashcard('b1_21', 'Passiv (v)', 'Passive Voice', 'B1', 'Grammar', 'Wird gemacht (is being done)'),
            new Flashcard('b1_22', 'Die Beziehung (f)', 'The relationship', 'B1', 'Nouns'),
            new Flashcard('b1_23', 'Die Entscheidung (f)', 'The decision', 'B1', 'Nouns'),
            new Flashcard('b1_24', 'Die Verbesserung (f)', 'The improvement', 'B1', 'Nouns'),
            new Flashcard('b1_25', 'Die Herausforderung (f)', 'The challenge', 'B1', 'Nouns'),
            new Flashcard('b1_26', 'Der Einfluss (m)', 'The influence', 'B1', 'Nouns'),
            new Flashcard('b1_27', 'Sich beschweren Ã¼ber (v)', 'To complain about', 'B1', 'Verbs'),
            new Flashcard('b1_28', 'Teilnehmen an (v)', 'To take part in', 'B1', 'Verbs', '+ Dativ'),
            new Flashcard('b1_29', 'Die LÃ¶sung (f)', 'The solution', 'B1', 'Nouns'),
            new Flashcard('b1_30', 'Umweltfreundlich', 'Environmentally friendly', 'B1', 'Adjectives'),
            new Flashcard('b1_31', 'Die Armut (f)', 'The poverty', 'B1', 'Nouns'),
            new Flashcard('b1_32', 'Der Reichtum (m)', 'The wealth', 'B1', 'Nouns'),
            new Flashcard('b1_33', 'Erstaunlich', 'Astonishing', 'B1', 'Adjectives'),
            new Flashcard('b1_34', 'Verbinden (v)', 'To connect / link', 'B1', 'Verbs'),
            new Flashcard('b1_35', 'VerÃ¶ffentlichen (v)', 'To publish', 'B1', 'Verbs'),
            new Flashcard('b1_36', 'Die Grundlage (f)', 'The basis / foundation', 'B1', 'Nouns'),
            new Flashcard('b1_37', 'Die Ausnahme (f)', 'The exception', 'B1', 'Nouns'),
            new Flashcard('b1_38', 'Die Mehrheit (f)', 'The majority', 'B1', 'Nouns'),
            new Flashcard('b1_39', 'Die Minderheit (f)', 'The minority', 'B1', 'Nouns'),
            new Flashcard('b1_40', 'Die Pflicht (f)', 'The duty / obligation', 'B1', 'Nouns'),
        ];

        // --- App State Management ---
        const appState = {
            allFlashcards: [],
            currentFlashcardIndex: 0,
            filteredFlashcards: [],
            activeSection: 'learn-section',
            settings: {
                currentLevel: 'All', // 'A1', 'A2', 'B1', 'All', 'User'
                currentCategory: 'All',
                newCardsPerSession: 10,
                reviewCardsPerSession: 20
            },
            userAddedCount: 0, // Counter for unique user card IDs
        };

        // --- Local Storage Utilities ---

        function saveState() {
            try {
                // Save card data and settings
                localStorage.setItem('germanFlashcards', JSON.stringify(appState.allFlashcards));
                localStorage.setItem('germanFlashcardsSettings', JSON.stringify(appState.settings));
                localStorage.setItem('germanFlashcardsUserCount', appState.userAddedCount);
            } catch (e) {
                console.error("Could not save state to localStorage:", e);
            }
        }

        function loadState() {
            try {
                const savedCards = localStorage.getItem('germanFlashcards');
                const savedSettings = localStorage.getItem('germanFlashcardsSettings');
                const savedUserCount = localStorage.getItem('germanFlashcardsUserCount');

                if (savedCards) {
                    // Re-hydrate card objects from raw JSON data
                    appState.allFlashcards = JSON.parse(savedCards).map(cardData => {
                        const card = new Flashcard(
                            cardData.id, cardData.german, cardData.translation,
                            cardData.level, cardData.category, cardData.hint, cardData.exampleSentence
                        );
                        // Convert timestamps back to Date objects for review logic
                        card.lastReviewed = cardData.lastReviewed ? new Date(cardData.lastReviewed) : null;
                        card.nextReview = cardData.nextReview ? new Date(cardData.nextReview) : null;
                        card.interval = cardData.interval || 0;
                        card.easeFactor = cardData.easeFactor || 2.5;
                        return card;
                    });
                } else {
                    appState.allFlashcards = initialVocab;
                }

                if (savedSettings) {
                    appState.settings = { ...appState.settings, ...JSON.parse(savedSettings) };
                }

                if (savedUserCount) {
                    appState.userAddedCount = parseInt(savedUserCount, 10);
                }

                // Ensure default vocab is present (for updates)
                const existingIds = new Set(appState.allFlashcards.map(c => c.id));
                initialVocab.forEach(initialCard => {
                    if (!existingIds.has(initialCard.id)) {
                        appState.allFlashcards.push(initialCard);
                    }
                });

                appState.allFlashcards.sort((a, b) => a.id.localeCompare(b.id)); // Sort for stability

            } catch (e) {
                console.error("Could not load state from localStorage:", e);
                // Fallback to initial data if loading fails
                appState.allFlashcards = initialVocab;
            }
        }

        // --- Spaced Repetition Logic (SM-2 Algorithm) ---

        /**
         * Calculates the next review time and interval based on recall quality.
         * @param {Flashcard} flashcard The card object to update.
         * @param {number} quality The quality of recall (0=Forgot to 5=Perfect).
         */
        function calculateNextReview(flashcard, quality) {
            let interval = flashcard.interval;
            let easeFactor = flashcard.easeFactor;

            if (quality >= 3) { // Correct answer (Good or Easy)
                if (quality < 5) { // Decrease ease slightly for 'Struggled' (3) or 'Good' (4)
                    easeFactor = Math.max(1.3, easeFactor - 0.15);
                } else { // Increase ease for 'Easy' (5)
                    easeFactor = easeFactor + 0.15;
                }

                if (interval === 0) {
                    interval = 1; // 1st successful review: next in 1 day
                } else if (interval === 1) {
                    interval = 6; // 2nd successful review: next in 6 days
                } else {
                    // Subsequent reviews: interval * easeFactor
                    interval = Math.round(interval * easeFactor);
                }
            } else { // Incorrect answer (Forgot or Hard)
                interval = 0; // Reset interval to 0 (review tomorrow/very soon)
                easeFactor = Math.max(1.3, easeFactor - 0.20); // Decrease ease factor
            }

            // Update card properties
            flashcard.interval = interval;
            flashcard.easeFactor = easeFactor;
            flashcard.lastReviewed = new Date().getTime(); // Use timestamp
            
            const nextReviewDate = new Date();
            nextReviewDate.setDate(nextReviewDate.getDate() + interval);
            flashcard.nextReview = nextReviewDate.getTime();
        }

        // --- Core Application Logic ---

        // DOM Elements
        const learnSection = document.getElementById('learn-section');
        const addSection = document.getElementById('add-section');
        const settingsSection = document.getElementById('settings-section');
        const aboutSection = document.getElementById('about-section');
        const allSections = [learnSection, addSection, settingsSection, aboutSection];

        function showSection(sectionId) {
            allSections.forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');

            // Update nav button styles
            document.querySelectorAll('#app-nav button').forEach(btn => {
                if (btn.id === `nav-${sectionId.split('-')[0]}`) {
                    btn.classList.remove('bg-gray-600', 'hover:bg-gray-700');
                    btn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                } else {
                    btn.classList.add('bg-gray-600', 'hover:bg-gray-700');
                    btn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                }
            });

            if (sectionId === 'learn-section') {
                filterAndPrepareCards();
            }
        }

        function filterAndPrepareCards() {
            const now = new Date().getTime();
            const { currentLevel, currentCategory, newCardsPerSession, reviewCardsPerSession } = appState.settings;

            let availableCards = appState.allFlashcards.filter(card => {
                const levelMatch = currentLevel === 'All' || card.level === currentLevel || (currentLevel === 'User' && card.id.startsWith('user_'));
                const categoryMatch = currentCategory === 'All' || card.category === currentCategory;
                return levelMatch && categoryMatch;
            });

            let dueReviewCards = [];
            let newCards = [];

            availableCards.forEach(card => {
                if (card.nextReview === null || card.nextReview <= now) {
                    if (card.interval === 0) { // New card (never seen or reset)
                        newCards.push(card);
                    } else {
                        dueReviewCards.push(card);
                    }
                }
            });

            // Sort review cards by review date (oldest due first)
            dueReviewCards.sort((a, b) => (a.nextReview || 0) - (b.nextReview || 0));

            // Limit and combine cards for the session
            newCards = newCards.slice(0, newCardsPerSession);
            dueReviewCards = dueReviewCards.slice(0, reviewCardsPerSession);

            appState.filteredFlashcards = [...newCards, ...dueReviewCards];
            appState.filteredFlashcards.sort(() => Math.random() - 0.5); // Shuffle the session

            appState.currentFlashcardIndex = 0;
            renderFlashcard(appState.filteredFlashcards[appState.currentFlashcardIndex]);
        }

        function handleReview(quality) {
            const currentCard = appState.filteredFlashcards[appState.currentFlashcardIndex];
            if (currentCard) {
                calculateNextReview(currentCard, quality);
                saveState();
            }

            appState.currentFlashcardIndex++;
            if (appState.currentFlashcardIndex < appState.filteredFlashcards.length) {
                renderFlashcard(appState.filteredFlashcards[appState.currentFlashcardIndex]);
            } else {
                learnSection.innerHTML = `
                    <div class="p-8 bg-green-50 rounded-lg text-center">
                        <h2 class="text-3xl font-bold text-green-700 mb-4">Session Complete! ðŸŽ‰</h2>
                        <p class="text-gray-700 mb-6">You've successfully reviewed all ${appState.filteredFlashcards.length} cards for this session. Great job on your consistency!</p>
                        <button onclick="filterAndPrepareCards()" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition">Start New Session</button>
                    </div>
                `;
            }
        }

        function renderFlashcard(card) {
            if (!card) {
                learnSection.innerHTML = `
                    <div class="p-8 bg-yellow-50 rounded-lg text-center">
                        <h2 class="text-2xl font-bold text-yellow-700 mb-4">No Cards to Review!</h2>
                        <p class="text-gray-700 mb-6">You have no cards due for review under your current settings, or you haven't added any yet.</p>
                        <p class="mb-4">Try one of these options:</p>
                        <button onclick="showSection('settings-section')" class="mr-3 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Change Filters</button>
                        <button onclick="showSection('add-section')" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600">Add New Cards</button>
                    </div>
                `;
                return;
            }

            // Convert next review timestamp back to a readable date string
            const nextReviewDisplay = card.nextReview
                ? new Date(card.nextReview).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
                : 'New Card';

            learnSection.innerHTML = `
                <h2 class="text-xl font-semibold text-gray-700 text-center mb-6">Reviewing Vocabulary</h2>
                <div class="flashcard-container" onclick="document.getElementById('current-flashcard').classList.toggle('flipped');">
                    <div class="flashcard" id="current-flashcard">
                        <div class="flashcard-face flashcard-front border-4 border-indigo-200">
                            <span class="text-3xl font-extrabold text-indigo-800">${card.german}</span>
                            ${card.hint ? `<small class="text-indigo-600 mt-2 text-sm font-medium">${card.hint}</small>` : ''}
                            <span class="absolute top-3 left-3 text-xs font-semibold text-gray-500 bg-indigo-100 px-2 py-0.5 rounded-full">${card.level}</span>
                        </div>
                        <div class="flashcard-face flashcard-back bg-indigo-50 border-4 border-indigo-400">
                            <p class="text-xl font-bold text-gray-800 mb-2">${card.translation}</p>
                            ${card.exampleSentence ? `<p class="text-sm text-gray-600 italic mt-1">"${card.exampleSentence}"</p>` : ''}
                            <div class="mt-4 text-xs text-gray-500">
                                <span class="block">Category: ${card.category}</span>
                                <span class="block">Next Review: ${nextReviewDisplay}</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-controls flex flex-wrap justify-center gap-3 mt-8" id="card-controls">
                    <button data-quality="0" class="flex-1 min-w-0 md:min-w-32 px-4 py-2 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition">Forgot (0)</button>
                    <button data-quality="3" class="flex-1 min-w-0 md:min-w-32 px-4 py-2 bg-yellow-500 text-white font-semibold rounded-lg hover:bg-yellow-600 transition">Struggled (3)</button>
                    <button data-quality="4" class="flex-1 min-w-0 md:min-w-32 px-4 py-2 bg-blue-500 text-white font-semibold rounded-lg hover:bg-blue-600 transition">Good (4)</button>
                    <button data-quality="5" class="flex-1 min-w-0 md:min-w-32 px-4 py-2 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 transition">Easy (5)</button>
                </div>
                <p class="text-center text-sm text-gray-500 mt-4">Card ${appState.currentFlashcardIndex + 1} of ${appState.filteredFlashcards.length} in this session.</p>
            `;

            document.getElementById('card-controls').addEventListener('click', (e) => {
                const quality = e.target.getAttribute('data-quality');
                if (quality !== null) {
                    handleReview(parseInt(quality, 10));
                }
            });
        }

        function renderAddCardForm() {
            addSection.innerHTML = `
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Add Your Own Flashcards</h2>
                <p class="text-gray-600 mb-6">Consolidate new vocabulary you encounter by adding it here. It will be integrated into your Spaced Repetition cycle immediately!</p>
                <form id="add-card-form" class="space-y-4">
                    <div>
                        <label for="german-word" class="block text-sm font-medium text-gray-700">German Word/Phrase (Mandatory)</label>
                        <input type="text" id="german-word" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                    </div>

                    <div>
                        <label for="translation" class="block text-sm font-medium text-gray-700">Translation (Mandatory)</label>
                        <input type="text" id="translation" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="level" class="block text-sm font-medium text-gray-700">Goethe Level</label>
                            <select id="level" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                                <option value="User">User Added (Default)</option>
                                <option value="A1">A1</option>
                                <option value="A2">A2</option>
                                <option value="B1">B1</option>
                                <option value="B2">B2</option>
                            </select>
                        </div>
                        <div>
                            <label for="category" class="block text-sm font-medium text-gray-700">Category (e.g., Nouns, Verbs)</label>
                            <input type="text" id="category" value="User Added" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                        </div>
                    </div>

                    <div>
                        <label for="hint" class="block text-sm font-medium text-gray-700">Hint (e.g., (m), plural form, conjugation)</label>
                        <input type="text" id="hint" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                    </div>

                    <div>
                        <label for="example-sentence" class="block text-sm font-medium text-gray-700">Example Sentence (German, optional)</label>
                        <textarea id="example-sentence" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border"></textarea>
                    </div>

                    <button type="submit" class="w-full px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition">Add Flashcard</button>
                </form>
                <div id="add-card-message" class="mt-4 text-center p-3 rounded-lg hidden"></div>
            `;

            document.getElementById('add-card-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const german = document.getElementById('german-word').value.trim();
                const translation = document.getElementById('translation').value.trim();
                const level = document.getElementById('level').value;
                const category = document.getElementById('category').value.trim();
                const hint = document.getElementById('hint').value.trim();
                const exampleSentence = document.getElementById('example-sentence').value.trim();
                const msgBox = document.getElementById('add-card-message');

                if (german && translation) {
                    appState.userAddedCount++;
                    const newId = `user_${appState.userAddedCount}`;
                    const newCard = new Flashcard(newId, german, translation, level, category, hint, exampleSentence);
                    appState.allFlashcards.push(newCard);
                    saveState();
                    
                    msgBox.textContent = 'Card added successfully! Ready for review.';
                    msgBox.className = 'mt-4 text-center p-3 rounded-lg text-green-700 bg-green-100 block';
                    
                    e.target.reset(); // Clear form
                    document.getElementById('category').value = 'User Added'; // Reset category default
                    
                    setTimeout(() => { msgBox.classList.add('hidden'); }, 4000);
                } else {
                    msgBox.textContent = 'Please fill in the German word and Translation fields.';
                    msgBox.className = 'mt-4 text-center p-3 rounded-lg text-red-700 bg-red-100 block';
                }
            });
        }

        function renderSettings() {
            const categories = [...new Set(appState.allFlashcards.map(c => c.category))].sort();

            settingsSection.innerHTML = `
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Learning Settings & Data Management</h2>

                <div class="mb-8 p-4 border rounded-xl shadow-sm">
                    <h3 class="text-xl font-semibold mb-4">Review Filters</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="setting-level" class="block text-sm font-medium text-gray-700">Filter by Goethe Level:</label>
                            <select id="setting-level" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                                <option value="All">All Levels</option>
                                <option value="A1">A1 (Beginner)</option>
                                <option value="A2">A2 (Basic User)</option>
                                <option value="B1">B1 (Independent User)</option>
                                <option value="B2">B2</option>
                                <option value="User">User Added Cards</option>
                            </select>
                        </div>
                        <div>
                            <label for="setting-category" class="block text-sm font-medium text-gray-700">Filter by Category:</label>
                            <select id="setting-category" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                                <option value="All">All Categories</option>
                                ${categories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                </div>

                <div class="mb-8 p-4 border rounded-xl shadow-sm">
                    <h3 class="text-xl font-semibold mb-4">Session Limits (SM-2 Control)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="setting-new-cards" class="block text-sm font-medium text-gray-700">Max NEW Cards per Session:</label>
                            <input type="number" id="setting-new-cards" min="0" max="50" value="${appState.settings.newCardsPerSession}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                        </div>
                        <div>
                            <label for="setting-review-cards" class="block text-sm font-medium text-gray-700">Max DUE Cards per Session:</label>
                            <input type="number" id="setting-review-cards" min="0" max="100" value="${appState.settings.reviewCardsPerSession}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                        </div>
                    </div>
                </div>

                <div class="mb-8 p-4 border rounded-xl shadow-sm">
                    <h3 class="text-xl font-semibold mb-4">Data Management</h3>
                    <button id="reset-progress-btn" class="px-4 py-2 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition w-full md:w-auto">Reset All Learning Progress</button>
                    <p class="text-sm text-gray-500 mt-2">This clears all review dates and intervals, but keeps your custom cards.</p>
                </div>
                
                <div id="settings-message" class="mt-4 text-center p-3 rounded-lg hidden"></div>
            `;

            // Set initial values
            document.getElementById('setting-level').value = appState.settings.currentLevel;
            document.getElementById('setting-category').value = appState.settings.currentCategory;

            // Event Listeners for settings changes
            document.getElementById('setting-level').addEventListener('change', (e) => {
                appState.settings.currentLevel = e.target.value;
                saveState();
            });
            document.getElementById('setting-category').addEventListener('change', (e) => {
                appState.settings.currentCategory = e.target.value;
                saveState();
            });
            document.getElementById('setting-new-cards').addEventListener('change', (e) => {
                appState.settings.newCardsPerSession = parseInt(e.target.value, 10);
                saveState();
            });
            document.getElementById('setting-review-cards').addEventListener('change', (e) => {
                appState.settings.reviewCardsPerSession = parseInt(e.target.value, 10);
                saveState();
            });

            // Reset Progress Button
            document.getElementById('reset-progress-btn').addEventListener('click', () => {
                const msgBox = document.getElementById('settings-message');
                if (window.confirm('Are you sure you want to reset ALL learning progress (intervals, review dates)?')) {
                    appState.allFlashcards.forEach(card => {
                        card.lastReviewed = null;
                        card.nextReview = null;
                        card.interval = 0;
                        card.easeFactor = 2.5;
                    });
                    saveState();
                    msgBox.textContent = 'Learning progress successfully reset!';
                    msgBox.className = 'mt-4 text-center p-3 rounded-lg text-green-700 bg-green-100 block';
                    setTimeout(() => { msgBox.classList.add('hidden'); }, 4000);
                }
            });
        }

        function renderAbout() {
            aboutSection.innerHTML = `
                <h2 class="text-2xl font-bold text-gray-800 mb-6">About the German Flashcard Master</h2>
                <div class="space-y-6 text-gray-700">
                    <p>This is a custom, single-page application designed to help you **memorize, revise, and consolidate** German vocabulary up to the B1 level, aligning with **Goethe-Institut standards** (CEFR).</p>

                    <h3 class="text-xl font-semibold border-b pb-1">Mastery through Spaced Repetition</h3>
                    <p>The core of this application is the **Spaced Repetition System (SRS)**, based on the highly effective SM-2 algorithm. It ensures you review words when you are just about to forget them, maximizing long-term memory retention.</p>
                    <ul class="list-disc list-inside ml-4 space-y-2">
                        <li>Words you mark as **'Forgot'** or **'Struggled'** will appear sooner.</li>
                        <li>Words you mark as **'Easy'** will have their review interval increased exponentially (e.g., 1 day, 6 days, 16 days, 30 days...).</li>
                        <li>This adaptive scheduling makes your study time incredibly efficient.</li>
                    </ul>

                    <h3 class="text-xl font-semibold border-b pb-1">Goethe A1-B1 Standard</h3>
                    <p>The initial vocabulary set is drawn from common core word lists for:</p>
                    <ul class="list-disc list-inside ml-4 space-y-2">
                        <li>**A1 (Beginner):** Focus on basic phrases, essential verbs (sein, haben), greetings, and concrete nouns.</li>
                        <li>**A2 (Basic User):** Introduces modal verbs (mÃ¼ssen, dÃ¼rfen), common separable verbs, prepositions with Dativ/Akkusativ, and basic sentence structure extensions.</li>
                        <li>**B1 (Independent User):** Covers complex grammar topics like Konjunktiv II (would), relative clauses, key conjunctions (obwohl, damit), and more abstract vocabulary needed for independent conversation and reading.</li>
                    </ul>

                    <h3 class="text-xl font-semibold border-b pb-1">Adding Your Own Content</h3>
                    <p>The **"Add Cards"** section allows you to seamlessly integrate any new words or grammatical points you find in your textbooks or daily life. They are given the status of new cards and immediately enter your personalized review cycle, ensuring everything you learn is consolidated.</p>
                </div>
            `;
        }

        // --- Initialisation and Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            loadState();
            
            // Pre-render hidden sections (for category list generation in settings)
            renderAddCardForm();
            renderSettings();
            renderAbout();

            // Initial view is the Learn section
            showSection('learn-section');
            filterAndPrepareCards();

            // Set up main navigation listeners
            document.getElementById('app-nav').addEventListener('click', (e) => {
                const targetId = e.target.id;
                if (targetId && targetId.startsWith('nav-')) {
                    const sectionName = targetId.split('-')[1];
                    showSection(`${sectionName}-section`);
                }
            });
        });
    </script>
</body>
</html>
